{% extends "appbuilder/base.html" %}

{% block content %}
{{ super() }}

<div class="page-header">
  <h1>Edit Vendor Interface</h1>
</div>

<ul class="nav nav-tabs">
  <li role="presentation"><a href="{{ url_for('VendorManagementView.dashboard') }}">Dashboard</a></li>
  <li role="presentation" class="active"><a href="{{ url_for('VendorManagementView.vendors') }}">Vendors</a></li>
</ul>

<ol class="breadcrumb">
  <li><a href="{{ url_for('VendorManagementView.vendors') }}">All</a></li>
  <li><a href="{{ url_for('VendorManagementView.vendor', vendor_id=interface.vendor.id) }}">{{ interface.vendor.display_name }}</a></li>
  <li><a href="{{ url_for('VendorManagementView.interface', interface_id=interface.id) }}">{{ interface.display_name }}</a></li>
  <li class="active">Edit</li>
</ol>

<form class="form-horizontal" method="post" action="{{ url_for('VendorManagementView.interface_edit', interface_id=interface.id) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <div class="form-group">
    <label for="vendor" class="col-sm-2 col-form-label">Vendor</label>
    <div class="col-sm-8" id="vendor">
      <a href="{{ url_for('VendorManagementView.vendor', vendor_id=interface.vendor.id) }}">
        {{ interface.vendor.display_name }}
      </a>
    </div>
  </div>
  <div class="form-group">
    <label for="interface" class="col-sm-2 col-form-label">Interface</label>
    <div class="col-sm-8" id="interface">
      <a href="{{ url_for('VendorManagementView.interface', interface_id=interface.id) }}">
        {{ interface.display_name }}
      </a>
    </div>
  </div>
  <div class="form-group">
    <label for="folio-data-import-profile-uuid" class="col-sm-2 col-form-label">Import Profile</label>
    <div class="col-sm-8">
      <select class="form-control" id="folio-data-import-profile-uuid" name="folio-data-import-profile-uuid">
        <option value="">SKIP DATA IMPORT</option>
        {% for job_profile in job_profiles %}
        <option {% if job_profile['id'] == interface.folio_data_import_profile_uuid %}selected{% endif %} value="{{ job_profile['id'] }}">
          {{ job_profile['name'] }}
        </option>
        {% endfor %}
      </select>
    </div>
  </div>  
  <div class="form-group">
    <label for="processing-delay-in-days" class="col-sm-2 col-form-label">Processing Delay (Days)</label>
    <div class="col-sm-8">
      <input type="number" class="form-control" id="processing-delay-in-days" name="processing-delay-in-days" placeholder="0" value="{{ interface.processing_delay_in_days }}">
    </div>
  </div>
  <div class="form-group">
    <label for="remote-path" class="col-sm-2 col-form-label">Remote Path</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="remote-path" name="remote-path" value="{{ interface.remote_path if interface.remote_path }}">
    </div>
  </div>
  <div class="form-group">
    <label for="file-pattern" class="col-sm-2 col-form-label">File Pattern</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="file-pattern" name="file-pattern" value="{{ interface.file_pattern if interface.file_pattern }}">
    </div>
  </div>
  <div class="form-group">
    <label for="archive-regex" class="col-sm-2 col-form-label">Archive Pattern</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="archive-regex" name="archive-regex" value="{{ interface.archive_regex if interface.archive_regex }}">
      <p class="help-block">For extraction from .tar.gz</p>
    </div>
  </div>
  <div class="form-group">
    <label for="active" class="col-sm-2 col-form-label">Active</label>
    <div class="col-sm-8">
      <label class="radio-inline">
        <input type="radio" id="true" name="active" value="true" {% if interface.active %}checked{% endif %}> True
      </label>
      <label class="radio-inline">
        <input type="radio" id="false" name="active" value="false" {% if not interface.active %}checked{% endif %}> False
      </label>
    </div>
  </div>

  <hr>

  <h3>MARC Processing Rules</h3>

  <div class="form-group">
    <label for="package-name" class="col-sm-2 col-form-label">Package Name:</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="package-name" name="package-name" value="{{ interface.package_name if interface.package_name }}">
    </div>
  </div>

  <section id="remove-fields">
    <template id="remove-fields-template">
      <div class="form-group remove-field">
        <label for="remove-field" class="col-sm-2 col-form-label">Field</label>
        <div class="col-sm-2">
          <input class="form-control" type="text" id="remove-field" name="remove-field" value="">
        </div>
        <div class="col-sm-2">
          <button class="btn btn-danger" onclick="removeRule(event); return false;">Remove Rule</button>
        </div>
      </div>
    </template>

    <div class="form-group" style="margin-top: 40px;">
      <div class="col-sm-2">
        <strong>Remove Fields</strong>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-primary col-sm-offset-1"
          onclick="newRemoveFieldRule(); return false;">Add Rule</button>
      </div>
    </div>
  </section>

  <section id="move-fields">
    <template id="move-fields-template">
      <div class="form-group move-field">
        <div class="col-sm-2">
          <label class="rule-label" for="move-field-from">From:</label>
          <input minlength="3" maxlength="3" type="text" id="move-field-from" name="move-field-from" value="">
        </div>
        <div class="col-sm-2">
          <label class="rule-label" for="move-field-to">To:</label>
          <input minlength="3" maxlength="3" type="text" id="move-field-to" name="move-field-to" value="">
        </div>
        <div class="col-sm-2">
          <button class="btn btn-danger" onclick="removeRule(event); return false;">Remove Rule</button>
        </div>
      </div>
    </template>
    
    <div class="form-group" style="margin-top: 40px">
      <div class="col-sm-2">
        <strong>Move Fields</strong>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-primary col-sm-offset-1" onclick="newMoveFieldRule(); return false;">Add Rule</button>
      </div>
    </div>

  </section>

  <hr>

  <div class="form-group">
    <div class="col-sm-1">
      <button class="btn btn-success">Save</button>
    </div>
    <div class="col-sm-1">
      <a class="btn btn-default" href="{{ url_for('VendorManagementView.interface', interface_id=interface.id) }}">Cancel</a>
    </div>
  </div>
</form>

<style>
  hr {
    margin-top: 30px;
    margin-bottom: 30px;
  }
  .rule-label {
    margin-right: 10px;
  }
</style>

<script>

   // Note: some of this feels like it might be bending over backwards to avoid pulling
   // in something like React or Vue for managing the state of this form?

  /**
   * A function to create an HTML element with a given name, attributes and text.
   */
  function element(name, attributes={}, text="") {
    const el = document.createElement(name);
    for (const [name, value] of Object.entries(attributes)) {
      el.setAttribute(name, value);
    }
    el.innerText = text;
    return el
  }

  /**
   * Creates a form element for a new Remove Field Rule and adds it to the form.
   */
  function newRemoveFieldRule(marcField='') {
    const template = document.getElementById("remove-fields-template");
    const clone = template.content.cloneNode(true);
    const now = new Date().getTime();

    updateInputTemplate(clone, "remove-field", now, marcField)
    updateLabelTemplate(clone, "remove-field", now)

    const removeFields = document.getElementById("remove-fields");
    removeFields.appendChild(clone);
  }

  /**
   * Creates a Move Field Rule element and adds it to the form.
   */
  function newMoveFieldRule(fromField='', toField='') {    
    const template = document.getElementById("move-fields-template");
    const clone = template.content.cloneNode(true);
    const now = new Date().getTime();

    updateInputTemplate(clone, "move-field-from", now, fromField)
    updateLabelTemplate(clone, "move-field-from", now)
    updateInputTemplate(clone, "move-field-to", now, toField)
    updateLabelTemplate(clone, "move-field-to", now)

    const moveFields = document.getElementById("move-fields");
    moveFields.append(clone);
  }

  function removeRule(event) {
    const el = event.target;
    const rule = el.parentNode;
    const field = rule.parentNode;
    const form = field.parentNode;
    form.removeChild(field);
  }

  function updateInputTemplate(clone, id, now, value) {
    const input = clone.querySelector(`#${id}`);
    updateTemplateAttr(input, "id", now)
    updateTemplateAttr(input, "name", now)
    input.value = value
  }

  function updateLabelTemplate(clone, id, now) {
    const label = clone.querySelector(`label[for="${id}"]`);
    updateTemplateAttr(label, "for", now)
  }

  function updateTemplateAttr(templateElement, attrName, now) {
    const value = templateElement.getAttribute(attrName);
    templateElement.setAttribute(attrName, getId(now, value))
  }

  function getId(now, name) {    
    return `${name}-${now}`;
  }

  function main() {
    {% for delete_marc in interface.delete_marc %}
      newRemoveFieldRule("{{ delete_marc }}");
    {% endfor %}

    {% for change_marc in interface.change_marc %}
      newMoveFieldRule("{{ change_marc['from'] }}", "{{ change_marc['to'] }}");
    {% endfor %}
  }

  addEventListener("load", main);

</script>

{% endblock %}
